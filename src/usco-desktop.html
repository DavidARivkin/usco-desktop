<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-icons/core-icons.html">
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-media-query/core-media-query.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../components/paper-input/paper-input-decorator.html">
<link rel="import" href="../components/core-list/core-list.html">

<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>

<link rel="import" href="adress-bar.html">


<polymer-element name="usco-desktop">
  <template>
    <style>
    :host{
      position:absolute;
      width:100%;
      height:100%;
      background:#f5f5f5;
      
      font-family: 'Montserrat';/*, sans-serif*/
      overflow:hidden;
    }
    
    core-toolbar {
      color: #f1f1f1;
      fill: #f1f1f1;
      background: #0CA9E3;/*#18294D;/*#0CA9E3;*/
      
      /*height:46px;*/
    }
    
    core-toolbar /deep/ #topBar{
      /*height:46px;*/
    }
    
    core-toolbar /deep/ #bottomBar{
      /*
      -webkit-user-select: none;
      -webkit-app-region: drag;*/
    }
    
    /*search related styling*/
    .searchField{
      opacity: 0;
      
      -webkit-transition: opacity .15s ease-in-out;
      -moz-transition: opacity .15s ease-in-out;
      -ms-transition: opacity .15s ease-in-out;
      -o-transition: opacity .15s ease-in-out;
      transition: opacity .15s ease-in-out;
    }
    .searchField /deep/ ::-webkit-input-placeholder {
      color: white;
      font-size:0.8em;
    }

    .searchField /deep/ ::-moz-placeholder {
      color: white;
      font-size:0.8em;
    }

    .searchField /deep/ :-ms-input-placeholder {
      color: white;
      font-size:0.8em;
    }
    
    .searchField /deep/ .unfocused-underline {
      background-color: #f1f1f1;
    }

    .searchField /deep/ .focused-underline {
      background-color: white;
    }
    
    /* only used for node webkit, frameless version:
    set this style to define the draggable item, see here
    for more info: https://github.com/nwjs/nw.js/wiki/Frameless-window
    */
    .windowDragger{
      -webkit-user-select: none;
      -webkit-app-region: drag;
    }
    
    .content{
      height:80%;
    }
    
    .filesAndFolders{
      padding:10px;
    }
    .filesAndFoldersList{
      overflow: auto;
      height: 100%;
      padding: 5px;
    }
    .fafFolder{
      color:red;
      cursor:pointer;
    }
     .fafFile{
      color:blue;
    }
    
    </style>
   
    <core-toolbar class="core-narrow">
      <paper-icon-button icon="menu"></paper-icon-button>
      <span flex>USCO-DESKTOP</span>
      
      <span>
        <adress-bar uri="{{currentPath}}"> </adress-bar>
      </span>
      <span>
        <paper-input-decorator label="search..." class="searchField" id="srchField"> 
          <input id="searchField" type="text" on-keyup="{{search}}" /> 
        </paper-input-decorator>
      </span>
      <paper-icon-button icon="search" on-click="{{ toggleSearch }}"> </paper-icon-button>
      <span id="results" style="position:absolute;top:40px;left:50%;z-index: 9999999;color:black;background:white">
        <template repeat="{{result in searchResults}}">
          <div style="cursor:pointer" on-tap="{{blah}}">{{result}}</div>
        </template>
      </span>
      <paper-icon-button icon="more-vert"></paper-icon-button>
    </core-toolbar>
    
    <div class="content">
      Files and folders
      <div class="filesAndFolders">
      
        <!--
        <ul class="filesAndFoldersList">
          <template repeat="{{item in _pathItems}}">
            <li class="{{ {fafFolder: item.type == 'folder', fafFile: item.type == 'file'} | tokenList}}"
            on-click="{{explore}}"
            >
              {{item.name}}  {{item.type}}
            </li>
          </template>
        </ul>-->
        <core-list data="{{_pathItems}}" selection="{{selectedPathItem}}" class="filesAndFoldersList">
          <template>
            <div class="{{ {fafFolder: model.type == 'folder', fafFile: model.type == 'file'} | tokenList}}">
              {{model.name}}
            </div>
          </template>
        </core-list>
        
        
      </div>
    </div>
  </template>
  <script>
  Polymer("usco-desktop",{
    _searchActive : false,
    
    currentPath:null,
    _pathItems : [],
    selectedPathItem: null,
    
    domReady:function(){
      console.log("app ready"); 
      this.currentPath = "/home/mmoissette/reprap"
    },
    //internal api
    toggleSearch:function(){
      this._searchActive = !this._searchActive;
    },
    selectedPathItemChanged:function(){
    
      console.log("selectedPathItem",this.selectedPathItem);
      this.explore( this.selectedPathItem );
    },
    explore: function( pathItem ){
      if(pathItem.type == "folder"){
        this.currentPath += "/"+ pathItem.name;
      }
    },
    fetchFiles:function( path ){
      var fs = require("fs");
      
      var listing = fs.readdirSync( path );
      var items = [];
      for(var i=0;i<listing.length;i++){
        //console.log(listing[i]);
        var stats = fs.statSync( path + "/" + listing[i] );
        //console.log(stats);
        
        var item = {name:listing[i]};
        
        if(stats.isFile() )
        {
          item.type = "file";
        }
        if(stats.isDirectory() )
        {
          item.type = "folder";
        }
        
        items.push( item );
      }
      
      this._pathItems = items;
    },
    //attribute change handlers
    currentPathChanged:function(){
       if(!this.currentPath) return;
       this.fetchFiles( this.currentPath ); 
    },
    _searchActiveChanged:function(){
      if( this._searchActive ){
        this.$.srchField.style.opacity = 1;
        this.$.searchField.focus();
      }else{
        this.$.srchField.style.opacity = 0;
      }
    }
    
  });
  </script>
</polymer-element>
